import express from 'express';
import {Request, Response} from "express";
import {getRepository} from "typeorm";
import {<%= entity.namePascal %>Base} from '../../<%= entity.getRelativeRoot() %>/design/<%= entity.pathFromRoot %>/components/generated/<%= entity.name %>.generated';

export default express.Router()
    /**
     * Request all entities.
     */
    .get("/<%= entity.name %>", async (req: Request, res: Response) => {
        res.send(await getRepository(<%= entity.namePascal %>Base).find({relations: [<%- entity.attributesCombined.filter(x => x.typeRef && !x.isArray).map(x => `"${x.name}"`).join(',') %>]}));
    })

    /**
     * Request entity by id.
     */
    .get("/<%= entity.name %>/:id", async (req: Request, res: Response) => {
        res.send(await getRepository(<%= entity.namePascal %>Base).findOne(req.params.id, {relations: [<%- entity.attributesCombined.filter(x => x.typeRef).map(x => `"${x.name}"`).join(',') %>]}));
    })

    /**
     * Create new entity.
     */
    .post("/<%= entity.name %>", async (req: Request, res: Response) => {
        const repository = getRepository(<%= entity.namePascal %>Base);
        const entity = repository.create(req.body);
        res.send(await repository.save(entity));
    })

    /**
     * Update existing entity.
     */
    .put("/<%= entity.name %>/:id", async (req: Request, res: Response) => {
        const repository = getRepository(<%= entity.namePascal %>Base);
        const entity = await repository.findOne(req.params.id);

        if(entity) {
            repository.merge(entity, req.body);
            res.send(await repository.save(entity));
        } else {
            res.sendStatus(404);
        }
    })

    /**
     * Delete entity.
     */
    .delete("/<%= entity.name %>/:id", async (req: Request, res: Response) => {
        const repository = getRepository(<%= entity.namePascal %>Base);
        const entityToDelete = await repository.findOne(req.params.id);

        if(entityToDelete) {
            res.send(await repository.remove(entityToDelete));
        } else {
            res.sendStatus(404);
        }
    });
