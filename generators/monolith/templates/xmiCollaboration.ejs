<% const firstCmp = entity.messages && entity.messages.length && entity.messages[0].to.elementRef; %>
<% const firstOperation = firstCmp && firstCmp.operations.find(x => x.name === entity.messages[0].operation.name); %>
<%- include('partial/collaboration/import', {entity: entity}) -%>
<% firstOperation && firstOperation.inputParameters.filter(x => x.typeRef).forEach(x => { %>
    import {<%= x.typeRef.namePascal %>} from '<%= entity.getRelativePath(x.typeRef) %>/components/<%= x.typeRef.name %>';
<% }) %>

export class <%= entity.namePascal %> {
    <%- include('partial/collaboration/constructor', {entity: entity}) -%>

    /**
    /* Execute process
    */
    run(inputState: FlowStateType & {
    <% firstOperation && firstOperation.inputParameters.forEach(x => { %>
        <%= x.name %>: <%= x.typeRef ? `${x.typeRef.namePascal}${x.isArray ? '[]' : ''}` : x.type %>,
    <% }) %>
    }, returns?: any) {
        let flowAsync = Promise.resolve(inputState);

        // Configure state storage
        flowAsync = flowAsync.then((state: any) => {
            console.log('--> initialize local state storage');
            storage.init(/* options ... */);
            state.flowStart = new Date();
            return state;
        });

        // define flow
        <%- include('partial/collaboration/flow', {entity: entity}) -%>

        return flowAsync.then((state: any) => {
            delete state.start;
            state.flowEnd = new Date();

            return state;
        }).catch(x => console.log(chalk.red('ERROR: '), x));
    }
}
