<% const build = (parent, callback) => (parent.children || []).forEach(x => { callback(x); build(x, callback); }) %>

import { Component } from '@angular/core';
import {AbstractControl, FormBuilder, FormGroup, Validators} from '@angular/forms';
import {ActivatedRoute, Router} from '@angular/router';
import { HttpClient } from '@angular/common/http';
import {environment} from "../../<%= entity.getRelativeRoot() %>/environments/environment";

@Component({
  selector: 'app-<%= entity.name %>-screen',
  templateUrl: './component.html',
  styleUrls: ['./component.sass']
})
export class <%= entity.namePascal %>ScreenComponent {
  public data: any = {};
  public form: FormGroup;
  public response: any = null;

  constructor(private fb: FormBuilder,
              private router: Router,
              private activatedRoute: ActivatedRoute,
              private http: HttpClient) {
  }

  ngOnInit() {
    this.loadData();
    this.form = this.fb.group({
    <% (entity.children || []).filter(x => x.stereotype !== 'button').forEach(child => { %>
    <% if(child.stereotype === 'table') { %>
      <%= child.name %>: this.fb.array([]),
    <% } else { %>
      '<%= child.name %>': ['', Validators.required],
    <% } %>
    <% }) %>
    });
  }

  protected getGroupControls(formControlName: string): { [key: string]: AbstractControl } {
    return (<FormGroup>this.form.get(formControlName)).controls;
  }

  protected run(action: string) {
    const data = this.form.getRawValue();
    this.http.post(`${environment.api.url}/${action}`, data).subscribe((res: any) => {
      this.response = res;
      this.loadData();
    });
    return false;
  }

  private loadData() {
<% (entity.children || []).filter(x => x.stereotype).forEach(function (child, i) { %>
  <% if(child.links.informationFLow.length && child.links.informationFLow[0].end === child) {%>
    <% var elementRefPath = child.links.informationFLow[0].start.elementRef.getPathFromRootWithModifier(utils.kebabCase) %>
    this.http.post(`${environment.api.url}/<%= elementRefPath %>`, {})
      .subscribe((res: any) => <% if(child.stereotype === 'table') { %>this.form.setControl('<%= child.name %>', this.fb.array((res.returns || []).map((x: any) => this.fb.group(x))))<% } else { %>this.form.patchValue({ <%= child.name %>: res })<% } %>);
  <% } %>
<% }) %>
  }
}
