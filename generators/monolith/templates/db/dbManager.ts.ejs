import {getRepository, Repository, DeleteResult, FindManyOptions, createConnection, Connection} from "typeorm";
import {injectable} from "inversify";

<% classes.forEach((x, i) => { %>
import {<%= x.entity.namePascal %>} from '..<%= x.path %>/components/<%= x.entity.name %>';<% }) %>
const ormConfig = require('../../ormconfig.json');

type crudType<T> = {repository: Repository<T>, loadAll: () => Promise<T[]>, load: (id: number) => Promise<T | undefined>, save: (entity: T) => Promise<T>, delete: (id: number) => Promise<DeleteResult> };

@injectable()
export class DbManagerCommon {
private static _instance: DbManagerCommon | null = null;
    public static async getInstance() {
        const connectionInfo = {
            type: process.env.DB_TYPE, host: process.env.DB_HOST, port: process.env.DB_PORT,
            username: process.env.DB_USERNAME, password: process.env.DB_PASSWORD, database: process.env.DB_NAME };

        return this._instance || (this._instance = new DbManagerCommon(await createConnection({ ...connectionInfo, ...ormConfig})));
    }

<% classes.forEach((x, i) => { %>
    private <%= x.entity.name %>Repository: Repository<<%= x.entity.namePascal %>>;<% }) %>

    constructor(private connection: Connection) {
    <% classes.forEach((x, i) => { %>
        this.<%= x.entity.name %>Repository = getRepository(<%= x.entity.namePascal %>);<% }) %>
    }

<% classes.forEach((x, i) => { %>
    public get <%= x.entity.name %>(): crudType<<%= x.entity.namePascal %>> {
        return {
            repository: this.<%= x.entity.name %>Repository,

            loadAll: async (options?: FindManyOptions<<%= x.entity.namePascal %>>): Promise<<%= x.entity.namePascal %>[]> => await this.<%= x.entity.name %>Repository.find(options),
            load: async (id: number): Promise<<%= x.entity.namePascal %> | undefined> => await this.<%= x.entity.name %>Repository.findOne(id),
            save: async (entity: <%= x.entity.namePascal %>) => await this.<%= x.entity.name %>Repository.save(entity),
            delete: async (id: number) => await this.<%= x.entity.name %>Repository.delete(id)
        };
    }
<% }) %>
}
